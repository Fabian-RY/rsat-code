\documentclass{book}
%\documentstyle[makeidx]{book}
\makeindex
\include{rsat_latex_commands}
\usepackage{url}
\begin{document}
\title{Network Analysis Tools \\
Web server installation}

\author{
	Sylvain Broh\'ee \\
	\email{sbrohee@ulb.ac.be} \\
        \and \\
	Karoline Faust \\
	\email{kfaust@ulb.ac.be} \\
        \and \\
	Jacques van Helden \\
	\email{jvhelden@ulb.ac.be}\\
        \\
        \\
        \bigre
}


\maketitle

\newpage
\tableofcontents
\newpage

\section*{Description}

This document describes the installation procedure for the web server
of the \textbf{Network Analysis Tools} (\neat).

It assumes that you already installed the perl scripts and the
genomes, as described in the \RSAT installation guide and that it is 
working properly on the command line and as webserver. To this, please refer to the \RSAT webserver install guide.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Web server installation
\chapter{Web server installation}
\section{Installing a local web server}

As the Regulatory Sequence Analysis Tools, \neat includes a web server, which
offers a user-friendly interface for biologists. The main server is
available for academic users at \url{http://rsat.ulb.ac.be/neat/}. A
few additional mirrors have been installed in different countries.

\subsection{Web server pages}

The web pages are located in the directory
\file{rsa-tools/public\_html}. This directory contains both the HTML help
pages, and the PHP and CGI scripts.

\subsection{Apache modules}

The \neat interface mainly relies on PHP (and CGI only for the roc-stats tool). 
These modules should be installed on the web server, and activated in the Apache configuration files. 
The installation and configuration of CGI is described in manual of the web server of \RSAT.

To perform the following steps, you might dipose of the administrator permissions.

\subsubsection{PHP module for Mac OSX}

If your server is running under Mac OSX, you need to install a recent
version (at least v5) of the php module, which can be found at the following site. 
\url{http://www.entropy.ch/software/macosx/php/}

%Karoline, if you find something to add as a Mac specialist, you're welcome!

\subsubsection{PHP module for LINUX}

Generally, PHP5 is included with the Linux distribution or can easyly be installed using the installer (YAST, YUM, etc). Take care that the PHP5 Module for Apache 2.0 (apache2-mod\_php5) is installed. 

PHP5 can also be installed manually from the PHP website (\url{http://www.php.net/downloads.php}).

\subsubsection{Modification of php.ini}
In order for the server to work with \neat, you have to edit the file \file{php.ini} which is the main configuration file of PHP. Depending on your PHP installation, this file might be in different directory. In computers running Suse 10.3, this file is in the \url{/etc/php5/apache2/} directory. In this file, you must modify the following fields accordingly.

\begin{footnotesize} 
\begin{verbatim}
soap.wsdl_cache_enabled=0
max_execution_time = 2400    
max_input_time = 6000	;
memory_limit = 600M      
error_reporting  =  E_ALL & ~E_NOTICE
post_max_size = 300M
upload_max_filesize = 200M
default_socket_timeout = 3000
upload_tmp_dir = "/tmp/php/"
\end{verbatim} 
\end{footnotesize}

You must change permissions so that the directory \url{/tmp/php/} for temporary upload is writable by eveverybody. To this please type 

\begin{footnotesize} 
\begin{verbatim}
mkdir /tmp/php
chmod 777 php
\end{verbatim} 
\end{footnotesize}


\subsection{Tomcat}

A part of \neat is using axis web services, JSP and Java servlet pages and needs Tomcat
or an equivalent servlet engine to run.
Tomcat can be easily installed on SUSE with yast and is
usually located in \file{/usr/share/tomcat} after installation.
On MacOS, it is already installed by default.
Make sure to install at least Tomcat version 5.
We noticed however that Tomcat version 6 is more stable.
We will refer from now on to the Tomcat root directory as \$CATALINA\_HOME.

\subsubsection{Configuration of Tomcat}
If you would like to use the Tomcat manager, make sure to configure the file
tomcat-users.xml located in \$CATALINA\_HOME/conf.

Add a manager role with a special login and password, e.g.
\begin{verbatim}
<tomcat-users>
  <role rolename="tomcat"/>
  <role rolename="manager"/>
  <user username="tomcat" password="tomcat" roles="tomcat"/>
  <user username="metheadmin" password="mysecretpassword" roles="manager"/>
</tomcat-users>
\end{verbatim}

Make sure that tomcat-users.xml cannot be read by anyone else than tomcat or root.\\

By default, Tomcat takes a lot of memory. You can reduce this amount by
modifying the file tomcat.conf in \$CATALINA\_HOME/conf.
Outcomment and adjust the variable JAVA\_OPTS as follows:\\
JAVA\_OPTS="-Xmx250m"\\

You can start Tomcat on SUSE with\\
 \textit{/etc/init.d/tomcat6 start}\\
and stop it with\\
 \textit{/etc/init.d/tomcat6 stop}\\

More advice for the installation and configuration of Tomcat on unix systems
can be found at: \textit{http://linux-sxs.org/internet\_serving/book1.html}

\subsubsection{Mod\_jk}
Mod\_jk forwards requests for defined contexts from Apache to Tomcat.
Users that have a strict firewall configuration blocking the Tomcat port
will be able to access the web services through the Apache default port.

To install and configure mod\_jk, you can follow the steps below:

\begin{enumerate}
\item Install the mod\_jk module from \file{http://tomcat.apache.org/connectors-doc/}
      or via installation systems like yast.
      \pagebreak
\item In the Apache configuration folder
(e.g. \file{/etc/apache2/conf.d}), add two configuration files: workers.properties and tomcat.conf
\item Content of workers.properties
\begin{verbatim}
  # Define 1 real worker using ajp13
    # this coud be al list in the format
    # worker.list=worker1, worker2, worker3, worker4
    worker.list=worker1
    # Set properties for worker1 (ajp13)
    worker.worker1.type=ajp13
    worker.worker1.host=localhost
    worker.worker1.port=8009
\end{verbatim}
\item Content of tomcat.conf
\begin{verbatim}
    # Update this path to match your modules location
    LoadModule jk_module /usr/lib/apache2/mod_jk.so
    # Where to find workers.properties
    # Update this path to match your conf directory location
    JkWorkersFile /etc/apache2/conf.d/workers.properties
    # Where to put jk shared memory
    # Update this path to match your local log directory
    # JkShmFile /var/log/apache2/mod_jk.shm
    # Where to put jk logs
    # Update this path to match your logs directory location
    JkLogFile /var/log/apache2/mod_jk.log
    # Set the jk log level [debug/error/info]
    JkLogLevel error
    # Send everything for context to worker named worker1 (ajp13)
    JKMount /be.ac.ulb.bigre.graphtools.server/* worker1
    JKMount /metabolicpathfinding/* worker1
\end{verbatim}
\item Reload Apache (on SUSE \file{/etc/init.d/apache2} reload).
\end{enumerate}

\subsubsection{Preparation of folders for Tomcat}
In Linux, a tomcat user is created if Tomcat is installed via yast. Make sure
that this user has read, write and execution rights for the following folders:\\
\file{\$RSAT/contrib/REA}\\
\file{\$RSAT/contrib/kwalks/bin}\\
\file{\$RSAT/public\_html/data/KEGG}\\
\file{\$RSAT/public\_html/data/Stored\_networks}\\

If any of these folders does not yet exist, create them.

For installation of REA and kwalks see the section on third-party programs in
the RSAT install guide.

\subsection{Installation of Java tools server}
The graphtools server contains the java web services of NeAT. It is stored as a war file
in \file{\$RSAT/java/web}

Either place the war file \textit{be.ac.ulb.bigre.graphtools.server.war} in
\$CATALINA\_HOME/webapps and then start Tomcat or use the Tomcat manager\\
 (\file{http://localhost:8080/manager/html})
 to deploy the war file.

Go to \file{\$CATALINA\_HOME/webapps/be.ac.ulb.bigre.graphtools.server/WEB-INF}, open
\textit{serverConfig.txt} and set the value of RSAT\_ROOT to the value of \$RSAT.

You are done. You may read the section "Configuration remarks" for additional information.
If you want to install the metabolic pathfinder, continue with section "Metabolic Pathfinder".

\subsubsection{Configuration remarks}

The directory \file{\$RSAT/public\_html/data/Stored\_networks}
allows to store graph files for longer time
(remember that \file{\$RSAT/public\_html/tmp} should be cleaned regularly).

Organism-specific KGML files are
placed in \file{\$RSAT/public\_html/data/KEGG} in a folder with the KEGG organism name (e.g. sce).
You may place KGML folders for organisms yourself or you may let the program download
required KGML files on the fly. The default KGML version might be outdated
(check KEGG Release Notes for the correct version). To update the KGML version,\\
go to \file{\$CATALINA\_HOME/webapps/be.ac.ulb.bigre.graphtools.server/WEB-INF}, open
\textit{serverConfig.txt} and modify the value of the variable KGML\_VERSION.

\subsection{Metabolic Pathfinder}
After successful installation of the Java web services, you may install metabolic pathfinder,
which is a client of the pathfinder web service.

\subsubsection{Requirements of metabolic pathfinder}

Metabolic pathfinder has a number of additional requirements.
It needs dot, which can be obtained freely from \textit{http://www.graphviz.org/}.
Dot is needed to draw graphs.\\

It also needs postgres (version 8.2 or later) to store KEGG data.
Alternatively, KEGG data could be accessed via its API,
but this takes much longer than accessing locally stored data.
Postgres can be obtained freely from
\textit{http://www.postgresql.org/}.
For MacOS, you can use Darwinports to install postgres. On SUSE, you may
install it with yast (install postgresql and postgresql-server).\\

On SUSE, you may start the postgres server with
\textit{/etc/init.d/postgresql start}. On MacOS, you may start the postgres server
using a command similar to\\
\textit{pg\_ctl -D /usr/local/pgsql/data/ -l logfile start}.\\

The KEGG data is packaged as a postgres backup file located in\\
\file{\$RSAT/java/misc/metabolicdb\_dump\_13\_Oct\_2008.backup},
which can be loaded into postgres as follows:
\begin{enumerate}
\item Start postgres by typing the following on command line:\\
\textit{psql -U postgres}
\item In postgres, do:\\
\textit{create database "metabolic\_database" with owner "karoline" encoding='UTF8';}
\item Quit postgres and type on command line:\\
\textit{pg\_restore -d metabolic\_database metabolicdb\_dump\_13\_Oct\_2008.backup}
\end{enumerate}

\subsubsection{Installation of metabolic pathfinder}
Either place the war file \textit{metabolicpathfinding.war} located
in \file{\$RSAT/java/web} in\\
\$CATALINA\_HOME/webapps and then start
Tomcat or use the Tomcat manager to deploy the war file.

\subsubsection{Configuration of metabolic pathfinder}
Go to the folder
\file{\$CATALINA\_HOME/webapps/metabolicpathfinding/WEB-INF}.

Run the configuration script with the following command:\\
\textit{./configureWebxml.pl}

Open the web.xml file and set the variable "dotpath" to the location
of the dot binary, e.g. \file{/usr/bin/dot}

Finally, reload the metabolic pathfinding web application using the Tomcat manager.


When this is done, you have to restart the apache web server with the following command.

\begin{footnotesize} 
\begin{verbatim}
/etc/init.d/apache2 restart
\end{verbatim}
\end{footnotesize}


\subsection{Web services}

\subsubsection{Edit the WSDL file}
The web interface consists in web services that are called by the PHP web pages. Your computer must thus act as web service server. 

Firt, edit the file \file{RSATWS.wsdl} located in the \url{\$RSAT/public_html/web_services/} directory. At the very end of the file, the line

\begin{footnotesize} 
\begin{verbatim}
 <soap:address location="http://rsat.scmbb.ulb.ac.be/rsat/web_services/RSATWS.cgi"/>
\end{verbatim}
\end{footnotesize}

must be replaced by 

\begin{footnotesize} 
\begin{verbatim}
 <soap:address location="url_of_the_cgi_file_on_your_server"/>
\end{verbatim}
\end{footnotesize}

The URL can be \url{http://127.0.0.1/rsa-tools/web_services/RSATWS.cgi}.

\subsubsection{Edit the \neat config file}

Edit the \file{RSAT\_config.props} present in the main RSAT directory and edit the following fields so that they correspond to your local configuration.

\begin{footnotesize} 
\begin{verbatim}
neat_supported=1
neat_ws=web link to the WSDL file on your computer (e.g. http://127.0.0.1/rsa-tools/web_services/RSATWS.wsdl)
\end{verbatim}
\end{footnotesize}

\subsubsection{Change permissions of the temporary files and log files directories}

The directories \url{\$RSAT/public_html/logs/} and \url{\$RSAT/public_html/tmp/} must be writable. So, change the permissions

\begin{footnotesize} 
\begin{verbatim}
chmod 777 \$RSAT/public_html/logs/
chmod 777 \$RSAT/public_html/tmp/
\end{verbatim}
\end{footnotesize}

\end{document}
