%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Sequence retrieval
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Retrieving sequences}

The program \program{retrieve-seq} allows you to retrieve sequences
from a genome (provided this genome is supported on your machine). In
particular (and by default), this program extracts the non-coding
sequences located upstream the start codon of the query genes. The
reason for selecting upstream sequences (rather than coding) is that
regulatory elements are generally found upstream of the coding
regions, at least in microbial organisms.

\section{Retrieving a single upstream sequence}

First trial: we will extract the upstream sequence for a single
gene. Try:

{\color{Blue} \begin{footnotesize} 
\begin{verbatim}
retrieve-seq -type upstream -org Escherichia_coli_K12 \
    -q metA -from -200 -to -1
\end{verbatim} \end{footnotesize}
}

This command retrieves a 200 bp upstream sequence for the gene
\gene{metA} of the bacteria \org{Escherichia coli K12}. 

By default, coordinates are calculated from the start codon. Ideally,
we would prefer to retrieve sequences upstream of the Transcription
Start Site (\concept{TSS}), since this is the place where the RNA
polymerase starts to transcribe the gene. Unfortunately, the precise
location of the TSS is unknown for most genes, in most sequecned
genome. For this reason, the default reference is the start codon
rather than the TSS.

Note that for some organisms (e.g. \org{Homo sapiens}), genome
annotations include mRNA boundaries. In this case, the option
\option{-feattype mRNA} allows you to specify that the reference point
is the start of the mRNA (thus the TSS) rather than the start codon.

Whichever reference point you decide to use, negative coordinates
indicate sequences upstream to this reference point, and positive
coordinates downstream sequences. 

\begin{samepage}
With the default parameters, 
\begin{itemize}
\item[-] the reference point is the start codon;
\item[-] position $-1$ corresponds to the first residue upstream of
  the coding sequence; 
\item[-] position 0 is the first letter from the start codon (the A from
  ATG);
\item[-] positive coordinates indicate the coding sequence (downstream
  from the start codon).
\end{itemize}
\end{samepage}

To better understand the system of coordinates, try to locate the
start codon in the sequence obtained with the following commands.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -type upstream -org Escherichia_coli_K12 \
    -q metA -from -5 -to 6
\end{verbatim} \end{footnotesize}
}


\section{Combining upstream and coding sequence}

For \org{E.coli} genes, regulatory signals sometimes overlap the 5'
side of the coding sequence. By doing so, they exert a repression
effect by preventing RNA-polymerase from binding DNA. The command
\program{retrieve-seq} allows you to extract a sequence that overlaps
the start codon, to combine an upstream and a coding segment.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -type upstream -org Escherichia_coli_K12 \
    -q metA -from -200 -to 49
\end{verbatim} \end{footnotesize}
}

\section{Retrieving a few upstream sequences}

The option \option{-q} (query gene) can be used iteratively in a
command to retrieve sequences for several genes.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -org Escherichia_coli_K12 \
    -from -200 -to 49 -q metA -q metB -q metC
\end{verbatim} \end{footnotesize}
}

\section{Retrieving a larger list of upstream sequences}

If you have to retrieve a large number of sequences, it might become
cumbersome to type each gene name on the command-line. A list of gene
names can be provided in a text file, each gene name coming as the
first word of a new line.

To create a test file, you can execute the following steps:
\begin{enumerate}
\item to create a new file, call the standard unix command 

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
cat > PHO_genes.txt
\end{verbatim} \end{footnotesize}
} 

\begin{samepage}
\item You can now type a list of gene names, for example:
{\color{Blue} \begin{footnotesize}
\begin{verbatim}
PHO11
PHO3
PHO5
PHO88
PHO89
PHO87
PHO13
PHO2
PHO8
PHO4
PHO81
PHO12
PHO90
PHO86
PHO84
PHO23
PHO91
PHO80
PHO85
\end{verbatim} \end{footnotesize}
} 
\end{samepage}

\item Once you have finished typing gene names, press \texttt{Ctrl-D}

\item Check the content of your file by typing 

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
cat PHO_genes.txt
\end{verbatim} \end{footnotesize}
} 

\end{enumerate}

This file can now be used as input to indicate the list of genes. The option \option{-i} 

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -type upstream -i PHO_genes.txt \
    -org Saccharomyces_cerevisiae \
    -from -800 -to -1  
\end{verbatim} \end{footnotesize}
} 

The option \option{-o} allows you to indicate the name of a file where
the sequence will be stored.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -type upstream -i PHO_genes.txt \
    -org Saccharomyces_cerevisiae \
    -from -800 -to -1   -label name \
    -o PHO_up800.fasta
\end{verbatim} \end{footnotesize}
} 

Check the sequence file:

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
more PHO_up800.fasta
\end{verbatim} \end{footnotesize}
}


\section{Preventing the inclusion of upstream ORFs}

With the command above, we retrieved sequences covering precisely 200
bp upstream the start codon of the selected genes. Intergenic regions
are sometimes shorter than this size. In particular, in bacteria, many
genes are organized in operons, and the intergenic distance is very
short (typically between 0 and 50 bp). If your gene selection contains
many intra-operon genes, the sequences will be mainly composed of
coding sequences (more precisely ORF, open reading frame), which will
bias subsequent analyses.

The option \option{-noorf} of \textit{retrieve-seq} indicates that, if
the upstream gene is closer than the specified limit, the sequence
should be clipped in order to return only intergenic regions.

As an example, we will store the list of histidin genes in a file and
compare the results obtained with and without the option
\option{-noorf}.

Create a text file named \file{his\_genes.txt} with the following
genes.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
hisL
hisG
hisD
hisC
hisH
hisA
hisF
hisI
hisP
hisM
hisQ
hisJ
hisS
\end{verbatim} \end{footnotesize}
}

The default behaviour will return 200bp for each gene. 

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -type upstream -org Escherichia_coli_K12 \
    -i his_genes.txt -from -200 -to -1
\end{verbatim} \end{footnotesize}
}

With the option \option{-noorf}, sequences are clipped depending on
the position of the closest upstream neighbour.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -type upstream -org Escherichia_coli_K12 \
    -i his_genes.txt -from -200 -to -1 -noorf \
    -o his_up200_noorf.fasta

more his_up200_noorf.fasta
\end{verbatim} \end{footnotesize}
}

You can measure the length of the resulting sequences with the program
\program{sequence-lengths}.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
sequence-lengths -i his_up200_noorf.fasta
\end{verbatim} \end{footnotesize}
}

Notice that some genes have very short upstream sequences (no more
than a few bp, or even 0bp). These are the internal genes of the
\gene{his} operon. 


We will now apply the same option to the list of PHO genes entered
above, in order to obtaine the corresponding non-coding upstream
sequences, with a size up to 800bp.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -type upstream -i PHO_genes.txt \
    -org Saccharomyces_cerevisiae \
    -from -800 -to -1 -noorf  -label name \
    -o PHO_up800-noorf.fasta
\end{verbatim} \end{footnotesize}
} 

Check the sequence file:

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
more PHO_up800-noorf.fasta
\end{verbatim} \end{footnotesize}
}

We can now use the command \command{sequence-lengths} to compare the
sequence sizes of the files \file{PHO\_up800.fasta}, and
\file{PHO\_up800-noorf.fasta}, respectively.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
sequence-lengths -i PHO_up800.fasta

sequence-lengths -i PHO_up800-noorf.fasta
\end{verbatim} \end{footnotesize}
}

\section{Getting information about genes}

\RSAT include several utilities to obtain information about a set of
genes, we will illustrate some basic features. 

\subsection{Getting gene location, names and description}

In the previous section, we created a text file with the names of a
set of genes related to phosphate metabolism. The command
\command{gene-info} returns the complete information concerning a set
of genes. By default, the first word of each row of the input file is
considered as a query.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
gene-info -i PHO_genes.txt -org Saccharomyces_cerevisiae
\end{verbatim} \end{footnotesize}
}


\subsection{Selecting gene by name or description}

Another common need is to search all the names whose name or
description matches some string. For example, let us assume that we
want to ollect all the genes whose name indicates a role in the
methionine metabolism, in the yeast \org{Saccharomyces cerevisiae}.
The program \concept{gene-info} allows us to specify this type of
query. according to the naming convention in the yeast community, gene
names start with three letters indicating the function (e.g. PHO for
phosphate, MET for methionine), wollowed by a number. We can ask the
program to return all the gene names having the string ``MET'' in
their names. 

In this example, we will enter the query string with the option
\option{-q} on the command line, rather than in a file.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
gene-info -q 'MET' -org Saccharomyces_cerevisiae
\end{verbatim} \end{footnotesize}
}

We could also refine the query by taking advantage of our knowledge of
the yeast gene nomenclature, and selecting the genes whose name starts
with the prefix ``MET'', followed by one or several numbers.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
gene-info -q '^MET\d+' -org Saccharomyces_cerevisiae
\end{verbatim} \end{footnotesize}
}

The query is formulatd as a \concept{regular expression}, where
\texttt{$\backslash$d} indicates a number, and the symbol $+$ is a
multiplier, so \texttt{$\backslash$d+}, indicates that we accept a
succession of one or more numbers after the string ``MET''. The
character $\hat{ }$ indicates that the string MET should be at the start of
the name (thus, there can be no letter before MET).

We can now store this list of genes in a separate file, and retrieve
the coresponding upstream sequences.


{\color{Blue} \begin{footnotesize}
\begin{verbatim}
gene-info -q '^MET\d+' -org Saccharomyces_cerevisiae -o MET_genes.txt

retrieve-seq -type upstream -i MET_genes.txt \
    -org Saccharomyces_cerevisiae \
    -from -800 -to -1 -noorf  -label name \
    -o MET_up800-noorf.fasta
\end{verbatim} \end{footnotesize}
}


\subsection{Selecting genes by their description}

By default, the program \concept{gene-info} matches a query string
against the list of gene names for the selected organism. The option
\option{-descr} extends the search to the gene descriptions. For
instance, we could search all the genes having the word ``methionine''
in their description. 

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
gene-info -descr -q methionine -org Saccharomyces_cerevisiae
\end{verbatim} \end{footnotesize}
}

\subsection{Adding selected fields to a list of gene}

As we saw in the previous section, the program \program{gene-info}
takes as input a list of gene names or identifiers, and return the
complete description of each gene.

In some cases, one needs only a part of this information (e.g. the
common name, or the descripion), in order to to add some columns to a
pre-existing tab-delimited file where each row represents one
gene. For example, imagine that you have a file containing expression
profiles for 6,000 yeast genes, measured by microarray experiments
under 200 conditions. The file contains 201 columns: the first column
indicates the ID of each gene, and the 200 next column give expression
values measured in the 200 microarrays. In such case, you would
typically use \program{add-gene-info} to add a few columns after each
profile, in order to indicate the common name and the description of
each gene.

The program \concept{add-gene-info} allows add columns to an input
file, with user-selected fields of information about the genes. For
example, the options below will add the gene identifier and the list
of synonym to each row of our PHO gene list. 

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
add-gene-info -i PHO_genes.txt -org Saccharomyces_cerevisiae \
  -info id,names
\end{verbatim} \end{footnotesize}
}

If the input file contains additional columns (e.g. expression
profiles), these will be preserved in the output, and the requested
information columns will be added at the end of each row.

You can check the list of fields supported by \program{add-gene-info}
by consulting the help message.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
add-gene-info -help
\end{verbatim} \end{footnotesize}
}


\section{Retrieving sequences of a random selection of genes}

It is also sometimes interesting to select a set of random genes,
which canbe used as negative control or some analyses. This is exactly
the purporse of the program \program{random-genes}. We will perform a
random selection of 20 yeast genes, and retrieve their upstream
sequences. This selection will also be used in the next chapters.


{\color{Blue} \begin{footnotesize}
\begin{verbatim}
random-genes -org Saccharomyces_cerevisiae -n 20 -o RAND_genes.txt

retrieve-seq -type upstream -i RAND_genes.txt \
    -org Saccharomyces_cerevisiae \
    -from -800 -to -1 -noorf  -label name \
    -o RAND_up800-noorf.fasta
\end{verbatim} \end{footnotesize}
}

\section{Retrieving all upstream sequences}

For genome-scale analyses, it is convenient to retrieve upstream
sequences for all the genes of a given genome, without having to
specify the complete list of names. For this, simply use the option
\option{-all}.

As an illustration, we will use \command{retrieve-seq} to retrieve all
the start codons from \org{Escherichia coli}. As we saw before,
negative coordinates specify upstream positions, 0 being the first
base of the coding sequence. Thus, by specifying positions 0 to 2, we
will extract the three first coding bases, i.e. the start codon. 

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -type upstream -org Escherichia_coli_K12 \
    -from 0 -to 2 \
    -all -format wc -nocomments -label id,name \
    -o Escherichia_coli_K12_start_codons.wc
\end{verbatim} \end{footnotesize}
}

Check the result:

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
more Escherichia_coli_K12_start_codons.wc
\end{verbatim} \end{footnotesize}
}


\section{Retrieving downstream sequences}

\program{retrieve-seq} can also be used to retrieve downstream
sequences. In this case, the origin (position 0) is the third base of
the stop codon, positive coordinates indicate downstream (3')
location, and negative coordinates locations upstream (5') from the
stop codon (i.e. coding sequences). 

For example, the following command will retrieve 200pb downstream
sequences for a few yeast genes. The first nucleotides of the
retrieved sequences are those immediately after the stop codon.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -type downstream -org Saccharomyces_cerevisiae \
    -from 1 -to 200 -label id,name -q PHO5 -q MET4
\end{verbatim} \end{footnotesize}
}

Since with the option \option{-type downstream}, the coordinates
smaller than 1 indicate positions upstream of the stop codon, we can
use \program{retrieve-seq} to extract the stop codons for all the
genes of \org{Escherichia coli}.

{\color{Blue} \begin{footnotesize}
\begin{verbatim}
retrieve-seq -type downstream -org Escherichia_coli_K12 \
    -from -2 -to 0 \
    -all -format wc -nocomments -label id,name \
    -o Escherichia_coli_K12_stop_codons.wc
\end{verbatim} \end{footnotesize}
}
