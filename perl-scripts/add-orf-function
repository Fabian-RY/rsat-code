#!/usr/bin/perl
if ($0 =~ /([^(\/)]+)$/) {
    push (@INC, "$`lib/");
}
require "RSA.lib";
require "RSA.classes";



if ($ARGV[0] eq "-h") {
#### display full help message #####
  open HELP, "| more";
  print HELP <<End_of_help;
NAME
	add-orf-function

        v1.0, 1997 by Jacques van Helden (jvanheld\@ucmb.ulb.ac.be)
	
USAGE
        add-orf-function [-i inputfile] [-o outputfile] [-v] 
        [-col orf_column] -org organism
	
OPTIONS
        -h      (must be first argument) display full help message
        -help   (must be first argument) display options
	-v	verbose
	-i inputfile
		if not specified, the standard input is used.
		This allows to place the command within a pipe.
	-o outputfile
		if not specified, the standard output is used.
		This allows to place the command within a pipe.
	-col #  Indicate the column containing the ORF identifier.
                If not provided, all words looking like an ORF identifier
                are interpreted.
	-org organism
	     supported organisms : 
$supported_organisms
	
INPUT FORMAT
	Any text file containing yeats ORF identifiers.
	
OUTPUT FORMAT
	After each line containing reference to an ORF, a 
        column with ORF function is added. 
	
End_of_help
  close HELP;
  exit;
}

if ($ARGV[0] eq "-help") {
#### display short help message #####
  open HELP, "| more";
  print HELP <<End_short_help;
add-orf-function options
----------------
-h      (must be first argument) display full help message
-help   (must be first argument) display options
-i      input file
-o      output file
-v      verbose
-col #  ORF column
-org		organism
End_short_help
  close HELP;
  exit;
}

$start_time = `date`;
$ORF_column = 1;

#### initialise parameters ####
#$ORF_function_file = "$RSA/data/yeast/genome/MIPS.orf_function";


#### read arguments ####
foreach $a (0..$#ARGV) {

  if ($ARGV[$a] eq "-v") {
    $verbose = 1;
    
  } elsif ($ARGV[$a] eq "-i") {
    $inputfile = $ARGV[$a+1];

  } elsif ($ARGV[$a] eq "-o") {
    $outputfile = $ARGV[$a+1];

  } elsif ($ARGV[$a] eq "-col") {
    $ORF_column = $ARGV[$a+1];

    #### organism
  } elsif ($ARGV[$a] eq "-org") {
      $organism_name =$ARGV[$a+1];
  }

}

#### input file ####
$in = &OpenInputFile($query_file);

#### output file ####
$out = &OpenOutputFile($outputfile);

#### organism
&CheckOrganism($organism_name);

#### read data
&ReadOrfPositions($organism_name);
&ReadSynonyms($organism_name);


#### verbose ####
if ($verbose) {
  print ";add-orf-function result\n";
  if ($inputfile ne "") {
    print ";Input file	$inputfile\n";
  }
  if ($outputfile ne "") {
    print ";Output file	$outputfile\n";
  }
}


#### open ORF function file ###
#  unless (open ORF_FUNCTION, $ORF_function_file) {
#      print "\tcannot open ORF function table $ORF_function_file\n";
#      print "\ttype add-orf-function -h for help\n";
#      exit;
#  }

#  while (<ORF_FUNCTION>) {
#      if (/(\S+)\s+(.+)/) {
#  	$ORF_id = $1;
#  	$ORF_function = $2;
#  	$ORF_function =~ s/ {2,}/; /g;
#  	$ORF_function =~ s/\n//;
#      }
#      $function{uc($ORF_id)} =  $ORF_function;
#  }
#  close  ORF_FUNCTION;

###### execute the command #########
while ($current_line = <$in>) {
    if (!($current_line =~ /\S/) || 
	($current_line =~ /^;/)
	) {
	print $current_line;
	next;
    }
    $current_line =~ s/\r//g;
    chomp($current_line);
    if ($ORF_column > 0) {
	@columns = split("\t", $current_line);
	$query = uc($columns[$ORF_column - 1]);
	my $orf_id = "";
	my $name = "";
	my $descr = "";
	my $synonyms = "";
	if (defined($orf_id{$query})) {
	    $orf_id = $orf_id{$query};
	    $name = $name{$orf_id};
	    $descr = $descr{$orf_id};
	    @synonyms = @{$synonyms{$orf_id}};
	    if (@synonyms) {
		$synonyms = "[";
		$synonyms .= join (";", @synonyms);
		$synonyms .= "]";
	    }
	}
	print join ("\t", $current_line, $descr, $synonyms), "\n";
#	print join "\t", "HELLO", $current_line, $query, $orf_id, $descr, "\n";
#	if ($columns[$ORF_column+1] =~ /(y[a-p][rl]\S+)/i) {
#	    $ORF_id = $1;
#	}
#    } elsif ($current_line =~ /(y[a-p][rl]\S+)/i) {
#	$ORF_id = $1;
    }
#    print $out "$current_line\t";
#    print $out "$function{uc($ORF_id)}\n";
}


###### verbose ######
if ($verbose) {
  $done_time = `date`;
  print ";Job started $start_time";
  print ";Job done    $done_time";
}


###### close input file ######
if ($inputfile ne "") {
  close $in;
}

###### close output file ######
if ($outputfile ne "") {
  close $out;
}


exit(0);


########################## subtroutine definition ############################

